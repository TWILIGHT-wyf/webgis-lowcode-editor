## 组件图层功能实现原理总结（WebGIS 低代码编辑器）

本文系统梳理当前项目中“组件图层（Layer）”能力的核心实现，包括数据模型、渲染与排序、交互与命令、吸附/对齐、复制剪切粘贴，以及编辑态与运行态的关系与改进建议。

### 核心数据模型（Pinia）

- 文件：`src/stores/component.ts`
- 结构：
  - `component`：`{ id, type, position{x,y}, size{width,height}, rotation, zindex }`
  - `componentStore: component[]`：画布上的组件列表（平铺，不含分组/树）。
  - `selectComponent: component | null`：当前选中组件。
  - `isDragging: boolean`：全局拖拽态，驱动吸附线的绘制优化。
  - `clipboard: component[]`：简单的组件剪贴板（末尾元素视为最近一次复制/剪切）。
- 新增组件：`addComponent` 会将 `zindex` 设为当前最大 z + 1，确保新组件默认位于最上层。

小结：z-index 作为唯一排序键控制视觉叠放；选中与拖拽状态独立维护，便于跨组件共享交互状态。

### 渲染与排序策略（z-index 驱动）

- 文件：`src/components/Editor/CanvasBoard.vue`、`src/components/Editor/shape.ts|vue`
- 渲染：画布以 `v-for` 渲染 `componentStore`，每个组件被 `<Shape>` 包裹；实际层级由 `<Shape>` 外层容器的 `style.zIndex` 决定：
  - `useShape` 中 `wrapperStyle.zIndex = currentComponent.zindex`。
  - 因为所有组件均为 `position: absolute`，浏览器会按 `z-index` 做堆叠。
- 排序规范化：`normalizeZ()` 会按 zindex 升序将序列重排为 0..n-1，保证唯一且连续，避免长时间操作导致的稀疏/冲突。
- 层级命令：
  - `bringForward(id)` / `sendBackward(id)`：在规范化后序列中与相邻元素交换 `zindex`，实现“上移/下移一层”。
  - `bringToFront(id)` / `sendToBack(id)`：将目标设为 `max+1` 或 `min-1` 后再 `normalizeZ()`，实现“置顶/置底”。

对比：采用“交换 z 值 + 规范化”的方式，避免在数组层面移动元素带来的额外渲染抖动，同时保持 O(n log n) 以内的可控成本（少量组件基本可忽略）。

### 交互与命中（选择、拖拽、上下文菜单）

- 选择：
  - 在 `<CanvasBoard>` 中点击 `<Shape>` 触发 `selectedId(com.id)`；
  - `useShape` 的 `isSelected` 通过对比 `selectComponent.id === props.id` 实时计算；
  - 选中态会渲染 8 个缩放点和一个旋转手柄。
- 拖拽/缩放/旋转：
  - 通用交互钩子：`useCanvasInteraction`（`canvasBoard.ts`）。
    - 支持画布平移/缩放、组件拖拽（含移动阈值、舞台坐标系换算、拖拽开始/结束回调）。
  - 组件拖拽：`useShape` 中为包装器绑定 `enableDrag`；拖拽中会调用 `updateComponentPosition` 更新 `position`。
  - 缩放：按手柄方向计算宽高增量，结合全局 `scale` 矫正；限制最小尺寸，调用 `updateComponentSize`。
  - 旋转：以元素中心为参考计算角度，`updateComponentRotation` 更新 `rotation`。
- 右键菜单：
  - `useContextMenu` 负责菜单状态与动作分发；
  - 在组件上右键：显示“剪切/复制/粘贴/删除/上移/下移/置顶/置底”；
  - 在空白处右键：只显示“粘贴”（使用点击位置作为粘贴落点）。

补充：右键时会将屏幕坐标转换成以画布 `wrap` 为基准的“stage 坐标”，用于粘贴定位和菜单定位。

### 吸附/对齐（Snap）

- 文件：`src/components/Editor/snap.ts|vue`
- 思路：
  - 将组件抽象为旋转矩形，转换成世界坐标下的包围盒（含四角点、min/max/cx/cy）。
  - 相邻组件的“指导线”包含 min/cx/max 以及四角点坐标；拖拽中的组件计算自身锚点到邻居指导线的最短距离，若在阈值内（默认 10px）则吸附。
  - 返回：矫正后位置 + 需要绘制的对齐辅助线集合。
- 集成：
  - `useShape` 的拖拽回调中调用 `snapToNeighbors` 获得吸附后位置；
  - `Snap.vue` 监听 `selectComponent + isDragging`，在拖拽时用 `<canvas>` 将对齐线绘制在画布最上层。

要点：对齐计算在本地数据上完成，不依赖 DOM 查询；阈值与锚点粒度可扩展为“吸附到边/中心/网格/自定义参考线”。

### 复制/剪切/粘贴（Clipboard）

- `copy(id)` / `cut(id)`：将目标组件浅拷贝压入 `clipboard`（`cut` 同时删除原件）。
- `paste({x,y})`：读取 `clipboard` 最新一项，生成新 `id` 和 `zindex = max+1`，位置使用当前菜单点击处的舞台坐标。
- 注意：当前 `ContextMenu.vue` 对 `canPaste` 的判定仅基于 `clipboard` 引用存在，后续可改为 `clipboard.value.length > 0`。

### 编辑态 vs 运行态

- 编辑态：`CanvasBoard.vue + Shape + Snap + ContextMenu`，提供选择、拖拽、缩放、旋转、图层操作、吸附与右键菜单。
- 运行态：`pages/runtimeView.vue` 目前仅挂载业务组件（如 `MapWidget`），不包含编辑器外壳与层级命令；若要在运行态复用层级逻辑，可直接依赖 `zindex` 渲染策略，无需编辑态交互。

### 关键“契约”与边界情况

- 契约（输入/输出）：
  - 输入：组件的 `position/size/rotation/zindex` 和交互事件（鼠标、滚轮）。
  - 输出：渲染顺序（由 `zindex` 决定）、组件的几何属性（位置/尺寸/角度），以及辅助线绘制。
  - 错误模式：zindex 冲突通过 `normalizeZ` 收敛；拖拽阈值避免误触；最小尺寸限制规避负尺寸。
- 边界：
  - 大量组件时，频繁 `normalizeZ` 可能造成开销；可按需延迟或仅在命令后调用。
  - 旋转后的吸附采用包围盒与四角点，非精确“边缘对齐”，但在交互体验与性能间达成平衡。
  - `clipboard` 当前为浅拷贝，若后续引入“深属性/数据源”，需改为深拷贝与 Schema 化。

### 可演进方向（建议）

- 图层面板：提供显式层级树、可见性（eye）与锁定（lock）开关；
- 多选/框选：矩形选择与批量层级/对齐操作；
- 撤销/重做：基于命令栈或时间旅行的状态快照；
- 分组/解组：引入层级树（group/child），命令扩展到组；
- 持久化：将 `componentStore` 序列化到本地或服务端，支持导入导出；
- 吸附增强：支持网格/标尺/自定义参考线、磁性强度可调。

### 相关文件索引

- 数据与命令：`src/stores/component.ts`
- 画布与缩放/平移：`src/components/Editor/canvasBoard.ts`、`CanvasBoard.vue`
- 组件包装（层级/选中/几何交互）：`src/components/Editor/shape.ts`、`shape.vue`
- 吸附：`src/components/Editor/snap.ts`、`snap.vue`
- 上下文菜单：`src/components/Editor/contextMenu.ts`、`contextMenu.vue`

—— 以上为当前“组件图层”功能的完整实现脉络与关键取舍记录。
