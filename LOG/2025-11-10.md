## 2025-11-10 画布拖拽改造：绝对坐标 + 锚点方案

### 背景与目标

- 画布存在平移和平移（panX/panY）与缩放（scale）的组合变换，直接用鼠标增量（dx/dy）叠加到组件坐标，容易在不同缩放下出现手感不一致或轻微漂移。
- 传统增量拖拽还会出现一个问题：按住组件中间拖动，元素会“吸附”到左上角（即脱离按下点），体验不好。

目标：

- 统一用“舞台坐标系（stage）”的绝对坐标更新组件位置，避免累积误差、缩放失真。
- 引入“锚点（anchor）”：记录鼠标在组件内部的相对偏移，确保拖拽过程中鼠标与组件的相对位置保持不变，不会跳。

### 核心思路（公式）

将屏幕坐标映射为舞台坐标：

- 设鼠标屏幕坐标为 $(c_x, c_y)$，根容器（canvas wrap）边界为 `rootRect.left/top`，画布平移为 $(\text{panX}, \text{panY})$，缩放为 $s$。
- 则舞台坐标为：

$$
	ext{mouseStageX} = \frac{c_x - \text{rootRect.left} - \text{panX}}{s},\quad
	ext{mouseStageY} = \frac{c_y - \text{rootRect.top} - \text{panY}}{s}
$$

锚点（在按下时记录）：

$$
	ext{anchorX} = \text{mouseStageX} - \text{elLeft},\quad
	ext{anchorY} = \text{mouseStageY} - \text{elTop}
$$

拖拽时实时位置：

$$
	ext{newX} = \text{mouseStageX} - \text{anchorX},\quad
	ext{newY} = \text{mouseStageY} - \text{anchorY}
$$

说明：`elLeft/elTop` 为组件当前在 stage 中的 `left/top`（不受 world transform 影响）。这样计算保证了：

- 不管缩放、平移如何变化，坐标更新都精准。
- 鼠标按住组件的哪个点，拖动过程中就保持那个点的相对位置，不会“跳到左上角”。

### 代码落点与改动

- `src/components/Editor/CanvasBoard.vue`
  - provide 根容器 ref：`provide('canvasWrapRef', wrap)`，用于统一坐标基准。
  - 网格背景改到 `.stage`，保证随缩放/平移一起变换（更自然）。

- `src/composable/useCanvasInteraction.ts`
  - 新增选项：`rootRefForAbs`（根容器 ref）。
  - 在拖拽开始时计算锚点 `anchorX/anchorY`：先把鼠标映射到 stage，再减去元素当前 `left/top`。
  - 在 `mousemove` 中用绝对坐标公式计算 `(newX, newY)` 后回调 `dragCallback(newX, newY)`。
  - 事件节流：`onDragMove` 使用 `throttle(..., 16ms)` 保持 ~60fps。

- `src/components/Editor/shape.vue`
  - 注入 `canvasWrapRef` 并通过 `rootRefForAbs` 传递给交互组合函数。
  - 在 `dragCallback` 中使用“绝对位置”直接更新 store；为避免高频 commit，加了 `debounce(50ms)`（可按体验调整）。

### 为什么比“增量位移”更稳

- 绝对坐标每次都从“真实鼠标位置”倒推，不会因为浮点误差或帧丢失而累计偏移。
- 锚点保证拖拽的起始相对关系，用户按住哪里就拖哪里，不会吸附到元素角点。
- 缩放和平移都被统一纳入映射公式，手感在任意 scale 下都一致。

### 性能与交互

- 节流（throttle 16ms）：限制鼠标移动处理频率，保证丝滑但不占满主线程。
- 防抖（debounce 50ms）：减少频繁写 store；如果觉得位置跟随有延迟感，可降到 30ms 或在拖拽中改为直接 set、在松手后再最终 commit。

### 已知边界与后续优化

- 旋转（rotation）场景：当前拖拽仍以包围盒的 `left/top` 为基准；若希望沿元素“本地轴”拖动，需要引入旋转矩阵变换（可后续增强）。
- 吸附网格：可在 `newX/newY` 最终写入前做网格量化（如 `round(x / grid) * grid`）。
- 多选/约束：支持按住修饰键限定轴向（仅 X 或 Y）、或多选同步移动。

### 小结

通过“绝对坐标 + 锚点”的组合，我们把拖拽从“相对增量累积”升级为“屏幕→舞台的一次性映射”，辅以节流/防抖控制，最终得到：

- 缩放/平移无关的稳定手感；
- 按住哪里拖哪里的不跳动体验；
- 清晰的数学模型，便于扩展吸附、对齐、旋转本地轴拖拽等高级能力。
