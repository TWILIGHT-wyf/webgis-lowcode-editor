## 吸附与辅助线实现总结（2025-11-12）

### 目标

在组件拖拽、缩放、旋转过程中：

1. 动态计算与其它组件的可对齐参考线（边 / 中心 / 旋转后角点）。
2. 满足阈值时进行位置吸附（实时调整拖拽结果）。
3. 绘制辅助线进行视觉反馈，仅在拖拽时显示。

### 主要文件与职责

- `shape.ts (useShape)`: 封装组件交互（拖拽、缩放、旋转），在拖拽时调用吸附逻辑并实际写回吸附后位置。
- `snap.ts (useSnap)`: 提供几何计算（包围盒、角点、参考线）、吸附决策（阈值内选择最优偏移）。
- `snap.vue`: 监听选中组件 + 拖拽状态，调用吸附函数生成辅助线，并用 `<canvas>` 绘制参考线。
- `canvasBoard.ts (useCanvasInteraction)`: 抽象拖拽/平移/缩放通用交互，暴露 `onDragStart/onDragEnd` 回调给上层同步全局 `isDragging`。
- Pinia Store `component.ts`: 保存组件数组、选中组件、位置/尺寸/旋转及全局拖拽状态 `isDragging`。

### 几何与数据结构

`toBox(com)` 返回：

```
{
	minx, miny, maxx, maxy,   // 轴对齐包围盒范围
	cx, cy,                   // 包围盒中心
	corners: [{x,y} * 4]      // 组件绕中心旋转后的四个角点世界坐标
}
```

旋转处理：

- 输入 rotation 为字符串（如 `"30deg"`），统一解析为角度，再转弧度：`rad = deg * π / 180`。
- 以组件中心作为局部原点，构造未旋转的局部四角点 `(-w/2,-h/2)...`，乘旋转矩阵再平移回世界坐标。

参考线生成：`getGuideLines(box)`：

- X 方向参考线集合：`minx`, `cx`, `maxx` + 四个角点的 `x`。
- Y 方向参考线集合：`miny`, `cy`, `maxy` + 四个角点的 `y`。
  （使用 Set 去重，避免重复线。）

### 吸附逻辑（`snapToNeighbors(threshold, previewPos?)`）

流程：

1. 使用拖拽中的预览位置（如果传入）构造当前组件临时包围盒。
2. 计算自身锚点：
   - X 锚点：`minx`, `cx`, `maxx`, 四角 `x`。
   - Y 锚点：`miny`, `cy`, `maxy`, 四角 `y`。
3. 遍历所有其它组件包围盒，生成其参考线集合（边/中心/角点）。
4. 枚举 “我的锚点” 与 “邻居参考线” 的组合，计算偏移量 `dx = guideX - myX` / `dy = guideY - myY`。
5. 在 `|dx|` / `|dy|` ≤ 阈值时参与竞争，选取最小距离的那个作为 X/Y 最佳吸附结果（独立进行）。
6. 组合计算后的新位置：`newX = previewPos.x + bestDx`（若存在） / `newY` 同理。
7. 返回 `{ position, lines }` 用于实际更新位置与绘制参考线。

特性：

- X 与 Y 独立挑选最佳参考线，可形成“角点对齐”效果（同时命中 X 与 Y）。
- 支持：边对边、边对角、角对角、中心对中心等多种组合。
- 若没有任一轴满足阈值，则返回 `null`（不上吸附）。

### 拖拽集成（`shape.ts`）

拖拽回调中：

```ts
const snap = snapToNeighbors(10, { x, y })
if (snap) updateComponentPosition(snap.position) else updateComponentPosition({ x, y })
```

这样吸附是“实时生效”的，而不仅是显示辅助线。

### 辅助线绘制（`snap.vue`）

- 仅在 `isDragging && selectComponent` 条件下执行检测与绘制。
- 监听依赖：选中组件的 `x,y,width,height,rotation` + `isDragging`。
- Canvas 绘制：对返回的 `lines` 中的 `{x}` 画垂线，对 `{y}` 画横线；先清空再绘制，保证刷新。
- 结束拖拽或无吸附结果时清空画布。

### 状态同步

- `useCanvasInteraction` 内部拖拽阈值判断（例如 5px）触发真正拖拽开始，并调用上层的 `onDragStart` / `onDragEnd` 更新 Pinia 的 `isDragging`。
- 缩放 / 旋转的鼠标移动也设置 `isDragging`，保持语义一致。

### 可调整项 / 后续优化建议

1. 吸附优先级：目前按“最近距离”独立选择，可引入策略（例如优先角-角 > 边-边 > 中心）。
2. 返回结构扩展：`lines` 可加入来源类型 `kind: 'edge' | 'center' | 'corner'` 以便不同样式区分。
3. 多线显示：当前只显示命中的参考线，可同时显示所有在阈值范围内的候选以增强对齐提示。
4. 阈值动态调节：根据缩放比 `scale` 自适应，比如 `threshold = base / scale`。
5. 吸附动画：拖拽即将吸附时可做“磁性”视觉渐进反馈（例如淡入线、放大线）。
6. 撤销支持：在位置调整前记录旧坐标，为后续历史 / 撤销栈准备。

### 调试要点

- 确认 rotation 在 store 中保持字符串角度（如 `"45deg"`），解析函数允许常规格式。
- 拖拽时 `previewPos` 必须传入，避免使用旧位置计算导致吸附滞后。
- 旋转后吸附不准，多半是 transform-origin 与几何计算不一致；当前实现固定为中心一致。
- 若出现“抖动”，可在吸附发生后短暂锁定一个轴（例如本次已吸附 X，则在距离阈值外之前不再切换 X 对齐对象）。

### 核心代码片段索引

- 包围盒 + 角点：`snap.ts -> toBox`
- 参考线集合：`snap.ts -> getGuideLines`
- 吸附决策：`snap.ts -> snapToNeighbors`
- 拖拽集成：`shape.ts -> dragCallback`
- 画线：`snap.vue -> drawLines`
- 拖拽状态回调：`canvasBoard.ts -> onDragStart/onDragEnd`

### 当前状态评估

功能：边 / 中心 / 角点吸附逻辑已打通；拖拽时真实位置被修正；辅助线只在拖拽中展示。
稳定性：类型检查通过；无运行期错误（需在更多旋转角度与不同缩放下继续观察）。
可维护性：几何与交互职责分离清晰，后续可按建议迭代策略与表现层。

---

（以上为今日吸附与辅助线系统的实现与架构总结。）
