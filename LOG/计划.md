# 数据可视化大屏搭建平台项目计划（Vue 3 + TypeScript）

目标

- 在 4 周内交付一套“Schema 驱动 + 实时刷新”的数据可视化大屏搭建平台（编辑态 Studio + 运行态 Runtime），并提供在线 Demo、Docker 镜像、CI/CD、测试覆盖与演示视频。
- 体现数据平台前端能力：组件化、工程化、性能与可扩展性（组件市场/主题/数据源/发布回滚）。

岗位匹配亮点

- 数据平台/中后台/低代码方向：Vue3/TS、ECharts/AntV、图表与地图组件化、微前端/模块联邦、Monorepo、可观测性（Web Vitals/Sentry）。

项目形态与仓库策略

- 单仓库起步（当前仓库），后续可升级为 Monorepo：
  - apps/studio：搭建器（编辑态）
  - apps/runtime：运行时（只读态、用于发布）
  - packages/charts、packages/ui、packages/schema：可复用包（可后续抽离）
- 与现有页面打通：将现有地图页改造成 MapWidget，作为组件市场的一员。

项目定位升级（地图低代码化）

- 在“大屏搭建平台”的基础上，升级为“低代码地图数据可视化平台”：以 Schema/DSL 描述地图画布、图层、数据源与样式规则，支持模板化、一键发布与运行态只读。
- 地图引擎采用可插拔适配：轻量线用 Leaflet，专业线用 MapLibre GL + deck.gl（GPU）。对外暴露统一的 MapEngine API、LayerRegistry 与样式/过滤规则面板。

核心功能范围

- 画布与布局：拖拽/缩放、网格吸附、对齐线、断点（响应式）
- 组件市场：折线/柱状/饼图/指标卡/表格/地图等 ≥ 8 个组件
- Schema 驱动：仪表盘 Schema（布局 + 组件 + 数据源 + 主题）渲染与校验
- 数据源：REST/WS/Mock，变量与轮询、错误重试、节流/去抖
- 主题与权限：全局主题（明/暗）、RBAC 到组件级
- 发布与快照：导出/导入（JSON）、快照保存/加载、只读运行时
- 工程化：严格 TS、ESLint、Vitest/Playwright、CI/CD、Docker、Sentry、Web Vitals

新增（地图低代码化）

- MapCanvas/Layer Schema：画布（中心/缩放/底图/投影）、图层（type、dataSource、style、filter、order）。
- MapEngine 适配：leaflet 与 maplibre+deck.gl 双引擎，统一 addLayer/update/remove 接口。
- LayerRegistry：'heat' | 'cluster' | 'vector' | 'raster' | 'mvt' 等图层类型注册。
- 数据连接器：GeoJSON/CSV/TopoJSON/GeoTIFF、REST、WMS/WMTS、MVT、PostGIS API（逐步解锁）。
- 样式系统：分类/分段色带、透明度/大小映射、条件过滤与简单表达式（后续可升级表达式编辑器）。
- 模板与发布：模板市场、快照导入导出、一键发布运行态、图例/Popup 模板、图层顺序与分组。

技术选型

- Vue 3（script setup/Composition API）+ Vite + TypeScript（strict）
- 可视化：ECharts（或 AntV G2/Charts）
- 布局：vue-grid-layout 或 gridstack（优先：社区活跃/类型好）
- 数据：@tanstack/vue-query（缓存/重试/失效）、MSW v2（本地 Mock）
- 测试：Vitest + Vue Test Utils、Playwright
- 工程：ESLint/Prettier、Husky/commitlint、GitHub Actions、Docker + Nginx、Sentry、Web Vitals

4 周里程碑与验收标准

Week 1｜MVP 画布 + Schema 渲染 + 核心组件

- 交付
  - 画布与拖拽布局（网格吸附/对齐线），组件占位框
  - Schema 渲染器（根据 Schema 动态渲染组件）
  - 组件：折线/柱状/饼图/指标卡（4 个）
  - 数据源 Mock（MSW）与轮询（vue-query）
- 验收
  - 拖拽/缩放流畅（55+ FPS），组件支持自适应；typecheck/lint 全绿
  - Schema 导入后即可还原布局与组件

Week 2｜数据源与实时 + 主题 + 快照

- 交付
  - 数据源面板（REST/WS），变量占位替换、错误重试
  - 全局主题（明/暗）与主题变量传递到组件
  - 快照保存/加载、导出/导入 JSON
- 验收
  - 10+ 组件并发刷新时 P95 < 200ms；主题切换不抖动
  - 运行态可只读呈现同样布局与数据

Week 3｜工程化 + 权限 + 地图子应用接入

- 交付
  - 组件封装抽包（packages/charts/ui/schema 初版）
  - 权限到组件级（RBAC）
  - 地图组件 MapWidget（复用/改造现有 MapLibre 页），与图表联动
  - 导出图片（PNG）/局部截图
- 验收
  - 组件新增成本低（文档 + 示例）
  - 地图与图表联动顺畅，首屏 TTI < 2.5s

Week 4｜测试与发布 + CI/CD + Demo 与文档

- 交付
  - 单测与 e2e：至少 8 场景（加载/拖拽/主题/数据源/发布/运行态）
  - GitHub Actions：lint/type/test/build，产出 Docker 镜像
  - 在线 Demo 与 2 分钟演示视频，README 完整（架构/运行/部署/截图）
- 验收
  - CI 全绿；一条命令本地/服务器启动容器；运行态可读
  - 文档可复现：新人 10 分钟跑通

地图低代码化 4 周里程碑（与通用大屏并行推进）

- Week 1：HeatmapWidget + 数据预处理 + Schema 接入（map.heat）
  - 验收：运行态可渲染热力图，参数/筛选可控，TTI < 2.5s。
- Week 2：数据连接 + 聚合视图 + 地图 Schema
  - 交付：DataSource(REST+轮询)；cluster 视图（supercluster）；MapCanvas/Layer Schema 初版；简单过滤器。
  - 验收：热力/聚合可切换；Schema 能还原地图配置；错误重试与空态处理。
- Week 3：样式系统 + 模板与发布
  - 交付：规则式样式面板（分类/分段/色带/透明度/大小）、模板一键导入发布、快照导出/导入、图例/Popup 模板。
  - 验收：编辑态/运行态一致；主题/样式切换稳定；模板可复用。
- Week 4：工程化与演示
  - 交付：单测/E2E（地图渲染/筛选/样式/切换）、CI+Docker、在线 Demo、2 分钟演示视频；Sentry/Web Vitals 接入。
  - 验收：CI 全绿；性能与错误可观测；文档 10 分钟可复现。

任务拆分（Issue 模板示例）

- feat(canvas): 画布/网格/对齐线/拖拽
- feat(schema): Schema 类型与 zod 校验 + 渲染器
- feat(components): line/bar/pie/stat 初版
- feat(datasource): REST/WS 面板 + 轮询/重试 + 变量
- feat(theme): 主题切换与主题变量注入
- feat(snapshot): 导入/导出 JSON + 快照管理
- feat(map): MapWidget 接入 + 与图表联动
- feat(perm): RBAC 到组件级
- feat(export): PNG 导出/截图
- test(unit): Schema/数据映射/数据源逻辑单测
- test(e2e): 拖拽保存/主题切换/运行态渲染等
- ci: GitHub Actions（lint/type/test/build/docker）
- ops: Dockerfile + Nginx 配置 + 部署脚本
- docs: README/架构图/演示脚本与视频

关键验收指标（写进 README）

- 性能：TTI < 2.5s；拖拽帧率 ≥ 55 FPS；10+ 组件并发刷新 P95 < 200ms；主包 < 300KB(gzip)
- 质量：typecheck 0 错；ESLint 0 错；单测/组件覆盖 ≥ 70%；E2E ≥ 8 场景
- 工程：CI 全链路；Docker 镜像可复现；Sentry 上报有效；Web Vitals 采集
- 体验：编辑/运行态一致；主题切换/导入导出顺畅；错误可定位

落地要点与踩坑清单

- 布局性能：限制最小单元（grid size），拖拽节流，ResizeObserver 做自适应
- ECharts：启用 lazyUpdate，避免深度 diff；组件卸载时 dispose
- Schema：用 zod 严格校验；为版本升级预留迁移函数
- 数据源：WS 自动重连与幂等；REST 退避重试；缓存失效策略
- 安全与隔离：组件沙箱与注册白名单；CSP；跨组件通信规范
- 监控：Web Vitals 上报、Sentry Source Map 上传、隐私脱敏

展示物清单（务必准备）

- 在线 Demo（Studio + Runtime）
- Docker 镜像与启动命令
- README（特性亮点、架构图、运行/测试/部署、截图 5–8 张）
- 2 分钟演示视频（拖拽→配置数据→主题→发布→运行态）
- 简历“项目亮点”与“技术关键词”（数据平台/工程化）

时间表（精简版）

- D1–D3：画布 + Schema 渲染器 + 4 组件
- D4–D7：数据源/主题/快照
- D8–D10：组件抽包 + 权限 + 地图联动
- D11–D12：测试（unit/E2E）+ CI/CD
- D13–D14：Docker 化 + Demo + README + 演示视频

启动与验证清单

- 本地
  - npm run dev：开发
  - npm run type-check、npm run lint、npm run test、npm run test:e2e
  - npm run build；docker build -t dashboard-studio .
- CI：PR 自动执行 lint/type/test/build/docker，并产出镜像工件
- 监控：Sentry 面板可见错误与 Source Map 还原；Web Vitals 有数据

结语

- 以“可演示/可部署/可维护”为目标，按周交付可见成果与可复现环境。

## 学习前置与路径（建议在 Week 1 前/中同步推进）

### 核心必学（Week 1-2 立即需要）

1. Schema 驱动架构设计

- 内容：Widget 元数据设计（type/props/grid/dataSource）、Schema 版本化与迁移、从 Schema 推导组件 Props 的 TypeScript 技巧。
- 要点：DashboardSchema → 渲染器 → 组件注册表（type→component），以 zod 校验 Schema 输入。

2. ECharts 核心 API

- 内容：折线/柱状/饼图/散点/地图常用配置，ResizeObserver 自适应，主题与暗色模式，性能项（dataZoom、sampling、大数据量）。
- 建议：优先用 vue-echarts 封装，统一 resize/dispose 生命周期。

3. 拖拽布局库（二选一）

- 方案A：vue-grid-layout（Vue 生态成熟、上手快）；方案B：gridstack.js（框架无关、功能强大）。
- 要点：layout 数据结构、拖拽/缩放事件、断点与序列化。

### 进阶必学（Week 2-3）

4. 数据请求与状态

- TanStack Query（vue-query）：useQuery 缓存/轮询/错误重试/失效策略；与组件数据绑定。
- Pinia：编辑器态（选中/历史栈/对齐线开关）与运行态（全局变量/主题）。

5. WebSocket 实时数据

- 原生 WebSocket 或 vueuse/useWebSocket，心跳重连与幂等处理；与 ECharts 增量渲染结合。

### 样式与交互（Week 3-4）

6. 响应式布局与缩放适配

- 方案：固定设计稿宽高（如 1920×1080）+ transform: scale() 按宽度缩放；CSS 变量统一尺寸与色彩。

7. 主题系统

- CSS 变量主题（明/暗/科技蓝），ECharts 主题与 CSS 变量联动，Element Plus 暗色模式。

### 工程化（贯穿全程）

8. TypeScript 严格模式实践

- 联合类型/类型守卫、泛型约束、字面量类型 as const、组件 Props 推导。

9. 组件设计模式

- 容器/展示组件分离；作用域插槽；Provide/Inject 传递编辑器上下文与主题。

10. 性能优化基础

- v-memo 降低重渲染；ECharts 实例复用与销毁时机；虚拟滚动；Web Worker 处理重计算。

### 可选增强（按需）

11. 地图可视化（如保留 Map/DeckGL）

- GeoJSON、MapLibre GL JS 与 deck.gl 常用图层（Scatterplot/Hexagon）。

12. 动画与过渡

- CSS keyframes、Vue Transition、GSAP/anime.js 时间线动画。

13. 快照与导入导出

- JSON 序列化、Blob 下载、FileReader 读取与迁移。

### 4 周学习路线（与项目任务对齐）

- Week 1：
  - ECharts 看 5 个示例，封装 ChartWidget；集成 vue-grid-layout，实现拖拽/缩放；完善 Schema 类型与 zod 校验。
  - 验收：可拖拽放置折线/柱状/饼图与指标卡，运行态可渲染。

- Week 2：
  - 接入 vue-query，完成 REST 数据源与轮询/重试；新增 2–3 个图表；初版主题切换。
  - 验收：配置数据源后图表自动更新，主题切换稳定。

- Week 3：
  - 属性面板/历史栈；抽离 charts/ui/schema 包雏形；接入 MapWidget 与图表联动；PNG 导出。
  - 验收：组件新增门槛低，地图与图表联动顺畅。

- Week 4：
  - 单测/E2E、CI/CD、Docker 与 Nginx；完善 README 与 Demo。
  - 验收：CI 全绿，一键容器启动，文档可复现。

### 面向 CRUD 基础的最小前置清单（1 周速通版）

为“只会 CRUD 和简单 axios 调用”的起点准备，目标是一周内具备最小可交付能力（能按 Schema 渲染组件、拉数据并可视化、具备基本布局与热力图）。该小节不替代上方完整路线，而是更聚焦、可立即执行的版本。

1. 必备能力（交付所需）

- TypeScript（基础到可用）
  - 要点：类型/接口、联合与交叉、类型收窄、基础泛型（函数/组件 props）。
  - 达标：组件 props/数据结构有明确类型；函数返回类型清晰；尽量不用 any。

- Vue 3（Composition API + SFC）
  - 要点：script setup、props/emits、ref/reactive、computed/watch、onMounted/onUnmounted；了解 provide/inject。
  - 达标：能写一个可接收外部参数与数据、并在卸载时正确清理副作用的组件。

- 路由与状态（轻量）
  - Vue Router：基础路由与动态参数。
  - Pinia：全局主题/变量存取；订阅变更。
  - 达标：Studio/Runtime 两页切换；公共状态可跨页读取。

- Schema 驱动 + zod 校验
  - 要点：JSON Schema（type/props/dataSource/layout）+ 组件注册表（type → component）；zod 做输入校验。
  - 达标：只改 JSON 就能改界面；异常输入有报错提示。

- 图表基建（ECharts）
  - 要点：折线/柱状/饼，ResizeObserver 自适应，主题切换，实例销毁（dispose）。
  - 达标：封装 ChartWidget，支持外部 options、容器尺寸变化不变形。

- 地图热力（Leaflet + leaflet.heat）
  - 要点：L.map/L.tileLayer/HeatLayer，fitBounds，invalidateSize，自定义半径/模糊/渐变；zoom 与半径联动。
  - 达标：HeatmapWidget.vue 可加载 JSON 并渲染热力，参数响应更新。

- 数据请求与缓存（@tanstack/vue-query）
  - 要点：useQuery 的 staleTime/refetchInterval/retry/select；错误与空态处理。
  - 达标：图表/热力按固定频率拉取数据，失败自动重试，不阻塞 UI。

- 布局拖拽（vue-grid-layout 或 gridstack）
  - 要点：layout 数据结构、拖拽/缩放事件、序列化/还原。
  - 达标：组件可拖拽/缩放；刷新后根据保存的 layout 还原。

2. 7 天速通安排（从 CRUD 到可交付）

- D1：TypeScript + Vue3 快冲
  - 产出：为 1–2 个现有组件补全 props/返回值类型；修一轮 TS 报错。

- D2：Router + Pinia
  - 产出：Studio/Runtime 两路由；Pinia 放主题或全局变量，页面可读写验证。

- D3：ECharts 封装
  - 产出：ChartWidget（options/resize/dispose）；放 1 张折线/柱状 demo。

- D4：Leaflet + leaflet.heat 最小热力
  - 产出：HeatmapWidget.vue 加载本地 JSON 并渲染；参数（radius/blur/minOpacity/gradient）即时生效。

- D5：Schema + zod + Registry
  - 产出：注册 map.heat 与 1 个 chart 类型；exampleSchema 能控制渲染（不改业务代码）。

- D6：vue-query + MSW
  - 产出：热力/图表改为 useQuery 拉数据；失败重试与空态提示；MSW 本地模拟接口。

- D7：布局拖拽 + 验收
  - 产出：引入布局库实现拖拽/缩放与序列化还原；跑一遍冒烟（渲染→调参→筛选→还原）。

3. 验收口径（本周）

- 改 JSON 即能改界面（Schema 生效，含参数与布局）。
- 热力图参数/筛选即时生效；zoom 与半径联动不卡顿。
- useQuery 拉数据有缓存/重试/空态；组件 resize 不变形、卸载无泄漏。
- 拖拽/缩放后保存 layout 并可还原；本地冒烟流程跑通。

4. 参考资料（官方优先）

- TypeScript Handbook 或 TS-Deep-Dive（任选其一快速扫）。
- Vue 3 官方文档（Composition API、SFC）。
- Vue Router、Pinia 官方文档（入门章节）。
- ECharts 官方示例 + API（先跟 3–5 个经典图）。
- Leaflet 与 leaflet.heat README（示例优先）。
- TanStack Query 文档（Queries 章节）。
- zod README（schema 定义与 refine）。

## Week 1｜南京热力地图（轻量型 MVP）执行清单

目标

- 在运行态渲染“南京市旅游打卡点”热力图，支持基础参数调节（半径/模糊/强度/渐变）与分类筛选，并能定位 TopN 热点。
- 使用公开合规数据，完成前端可直接消费的数据预处理，首屏加载 < 2.5s、交互流畅。

本周交付物

- 数据：`public/data/nanjing_poi.json`（字段：lng、lat、weight[0-1]、category、name）。
- 组件：`src/widgets/HeatmapWidget.vue`（Leaflet + leaflet.heat）。
- 注册：渲染器新增 `type: 'map.heat'` → HeatmapWidget；`exampleSchema` 添加一个热力图 widget。
- UI：半径/模糊/强度/渐变/最小透明度调节；分类筛选；TopN 列表点击定位。
- 文档：README/计划.md 添加“南京热力模板”使用说明（数据来源、参数表、如何替换数据）。
- 测试：1 个 unit（预处理函数）+ 1 个 e2e 冒烟（渲染/筛选/定位）。

每日任务（D1-D7）

- D1 数据准备（合规）
  - 用 Overpass/OSM 导出南京旅游类 POI（tourism=attraction|museum|viewpoint|historic…）。
  - 预处理生成标准 JSON：`{ lng, lat, weight, category, name }`，weight 可按类型给基础权重。
  - 验收：点数 ≥ 3,000；文件 ≤ 5MB；字段完整。

- D2 最小热力渲染
  - 安装 leaflet、leaflet.heat；编写 `HeatmapWidget.vue`，根据容器尺寸初始化地图与 HeatLayer。
  - 加载 `nanjing_poi.json` → 映射为 `[[lat, lng, weight], ...]` 传入 HeatLayer。
  - 验收：参数可调、无报错、重复进入页面无内存泄漏。

- D3 接入 Schema 与示例
  - 在渲染器注册 `map.heat`，在 `exampleSchema` 增加 widget（默认南京中心与合理 zoom）。
  - 验收：不改业务代码，仅改 Schema 即可控制位置和参数；构建通过。

- D4 分类筛选与 TopN
  - 从数据提取 category 列表做复选筛选；提供 TopN（按 weight 排序），点击定位（`map.flyTo`）。
  - 验收：筛选后热力实时更新；点击 TopN 能定位并有轻微高亮（可临时 Marker）。

- D5 交互与自适应
  - `fitBounds` 到数据范围；容器 `ResizeObserver` → `map.invalidateSize()`。
  - 按 zoom 动态调整 radius（低 zoom 大半径，高 zoom 小半径）。
  - 验收：首次进入自动适配；窗口缩放不变形；缩放观感稳定。

- D6 性能小优化
  - 低 zoom 简单抽样（如每 N 个点取 1 个）；参数变更节流（~300ms）。
  - 压力数据验证（复制/放大点集），观察 FPS 与交互延迟。
  - 验收：无明显掉帧；交互延迟 < 200ms（主观可接受）。

- D7 打磨与验证
  - 文档完善（数据来源/合规说明、参数表、替换指南）。
  - 测试：unit（预处理字段校验与 weight 归一化）、e2e（渲染→筛选→定位）。
  - 验收：本地一条命令构建通过；冒烟测试通过；他人 10 分钟可跑通。

接口与数据契约

- HeatmapWidget props（初版）：
  - `center: [lng, lat]`, `zoom: number`
  - `radius: number`, `blur: number`, `minOpacity: number`
  - `gradient?: Record<number, string>`（0-1 → 颜色）
  - `dataUrl: string`（默认 `public/data/nanjing_poi.json`）
- 数据格式：
  - `Array<{ lng: number; lat: number; weight: number; category?: string; name?: string }>`

验收标准

- 首屏 TTI < 2.5s；交互流畅（无明显卡顿）。
- 筛选/调参即时生效；TopN 点击可定位；Schema 可控。
- 构建与冒烟测试通过；文档清晰可复现。

风险与对策

- 坐标系：坚持 WGS84（OSM 瓦片）；不混用 GCJ-02 底图可避免偏移。
- 数据体积：D6 抽样 + 交互节流；必要时后续引入 supercluster/网格预聚合。
- 卡顿：减少热力重建次数，参数/筛选变更做节流；避免重复销毁/创建地图实例。


