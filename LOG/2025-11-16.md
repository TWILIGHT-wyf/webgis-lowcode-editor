# 2025-11-16｜数据来源功能与本地测试服务器

## 一、数据来源功能实现

- 目标：让组件可通过可配置 API 拉取数据，支持轮询、路径提取、错误处理；显示优先级为“远程数据 > 本地文本 props”。
- 数据模型：在 `src/stores/component.ts` 为组件新增 `dataSource` 字段（Text 组件默认提供）。
  - 字段：`enabled`、`url`、`method`、`headers`、`body`、`interval`(秒)、`dataPath`。
  - 默认：`defaultDataSourceByType('Text')` 返回完整默认值，并在 `addComponent` 时与样式、props 一并合并。

### 1) useDataSource 组合函数

- 位置：`src/datasource/useDataSource.ts`
- 入参：`Ref<DataSource | undefined>`；出参：`{ data, loading, error, fetchData }`。
- 请求流程（fetchData）：
  - 基于 DataSource 构造 Axios 配置（GET/POST/PUT/DELETE）。
  - 当 `method` 需要请求体时尝试 `JSON.parse(body)`；失败则返回错误“请求体 JSON 格式错误”。
  - 发起请求，将响应体按 `dataPath` 提取值（支持 `a.b[0].c` 的数组下标语法）；若未设置路径则使用完整响应数据。
  - 统一维护 `data`、`loading`、`error` 状态。
- 轮询：当 `enabled=true && url` 且 `interval>0` 时使用 `window.setInterval(ds.interval*1000)` 定时拉取；`interval` 变化或禁用时会自动清理并重建。
- 监听：`watch(dataSource, { deep:true, immediate:true })`，数据源改变立即请求；禁用时清空数据并停止轮询。
- 清理：`onUnmounted` 主动 `clearInterval`。
- 错误处理：捕获 AxiosError，设置 `error.value`，并确保 `loading` 正确收尾。

### 2) Text 组件集成

- 位置：`src/customComponents/text/Text.vue`
- 集成方式：
  - 使用 `dataSourceRef = toRef(() => comp.value?.dataSource)`，并调用 `useDataSource(dataSourceRef)`。
  - `content` 计算属性：当数据源启用且 `remoteData` 非空时优先显示远程数据（对象会 `JSON.stringify`），否则回退到 `props.text`。
  - 样式：用 `CSSProperties` 计算并应用文本样式（`fontWeight`、`textAlign`、`lineHeight`、`letterSpacing`、`padding` 等）。

### 3) 属性面板配置

- 位置：
  - 表单 schema：`src/components/siderBar/properties/properties.ts`
  - 面板渲染：`src/components/siderBar/properties/properties.vue`
- 字段：`enabled`(开关)、`url`、`method`(下拉)、`interval`(秒)、`dataPath`、`headers`、`body`。
- 绑定：`v-model="selectComponent.dataSource[field.key]"`（空缺会按 schema 默认值初始化）。
- 文本内容：从样式中分离为 `selectComponent.props.text`（本地文本）。

### 4) 单元测试（可选）

- 文件：`test/useDataSource.spec.ts` 使用 MSW（`msw/node`）模拟接口。
- 覆盖：GET/POST、路径提取、数组下标、轮询、禁用清空、错误处理、无效 JSON body 等。
- 运行：
  ```powershell
  npm run test:unit test/useDataSource.spec.ts
  ```

## 二、本地测试服务器搭建

- 背景：浏览器不允许 `file://` 作为网络请求源（报错 “Not allowed to load local resource: file:///api/text”），故需启用本地 HTTP 服务器。
- 实现：使用 `express + cors` 在 `test/mockServer.mjs` 启动一个可直接访问的 API。

### 1) 安装与启动

```powershell
cd test
npm install express cors
node mockServer.mjs
```

- 运行后服务地址：`http://localhost:3001`
- 服务器已启用 CORS，可被前端直接访问。

### 2) 已提供的测试接口

- 简单文本：
  - URL：`http://localhost:3001/api/text`
  - dataPath：`text`
- 嵌套数据：
  - URL：`http://localhost:3001/api/nested`
  - dataPath：`data.message`（或 `data.user.name`）
- 实时时间（建议轮询 1s）：
  - URL：`http://localhost:3001/api/time`
  - dataPath：`time`
- 计数器（建议轮询 2s）：
  - URL：`http://localhost:3001/api/counter`
  - dataPath：`message`
- 温度（建议轮询 3~5s）：
  - URL：`http://localhost:3001/api/temperature`
  - dataPath：`data.display`（或 `data.value`）
- 其他：`/api/random`、`/api/list`、`/api/echo`(POST 回显)、`/api/slow`(延迟 2s)、`/api/error`(返回 500)。

### 3) 在 Text 组件中的示例配置

- 示例一（简单文本）：
  - 启用：开
  - URL：`http://localhost:3001/api/text`
  - 方法：GET
  - dataPath：`text`
  - 轮询：0（不轮询）

- 示例二（时间轮询）：
  - 启用：开
  - URL：`http://localhost:3001/api/time`
  - 方法：GET
  - dataPath：`time`
  - 轮询：1（每秒）

## 三、排错记录与结论

- 错误：`Not allowed to load local resource: file:///api/text`。
  - 原因：尝试对 `file://` 协议发起网络请求。
  - 处理：改为使用 `http://localhost:3001` 的本地服务器。
- 错误：Axios `ERR_NETWORK`。
  - 原因：同上，或 URL 不正确。
  - 处理：确认服务已启动、URL 正确且已启用 CORS。

结论：

- 数据来源功能已具备“接口配置 + 路径提取 + 轮询 + 错误处理”的完整闭环，已在 Text 组件落地并可视化验证。
- 本地测试服务器可稳定支撑联调，避免 `file://` 与跨域干扰，推荐作为开发调试默认方案。

## 四、后续优化想法

- 请求超时/重试/退避策略；
- 取消中的请求（AbortController）与竞态规避；
- 更强的路径选择（如 JSONPath）；
- 轮询的抖动与前后台切换节能策略；
- 统一日志与可观测性（请求耗时、失败率）。
