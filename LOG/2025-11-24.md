# 2025-11-24 开发日志

## 今日概览

今天围绕“快速起步 & 一键成页”目标，完成页面模板系统的初版落地，并补齐代码生成、预览、导出、保存/加载的闭环；同时集中修复事件系统与若干组件在模板批量加载场景下暴露的问题，保证模板一键加载后整体稳定运行。

## 新增功能与模块

### 1. 页面模板系统 (src/templates/index.ts)

- 提供 4 个模板：数据大屏 (dashboard)、GIS 监控 (gis)、图表分析 (chart)、表单页面 (form)
- 模板内容含：标题文本、KPI 卡片、图表组件、表格 / Panel 等多类型组合
- 动画策略：统一使用 load 触发 + 递增 delay（0.2s 间隔）形成分层进入效果
- 占位策略：GIS 模板中暂用 Text 组件作为地图占位，后续将以真实地图组件替换
- ID 生成：时间戳 + 递增序号，避免与现有画布组件冲突

### 2. 代码生成与预览导出

- 工具文件：`src/utils/toCode.ts` 支持组件树转 Vue SFC（template / script / style）
- 预览页面：`src/pages/runtimeView.vue` 渲染顶层组件，提供刷新 / 查看 JSON / 查看代码 / 导出 .vue 功能
- 导出：生成 `generated-page-{timestamp}.vue` / 项目 JSON
- 支持事件：click / dblclick / mouseenter 自动生成处理函数骨架

### 3. 项目保存 / 加载 (header.vue)

- 结构：`{ components, canvasSize, savedAt }` 持久化到 localStorage 键 `webgis_project`
- 防护：加载前弹出确认；可重复覆盖；支持 JSON 导出备份

### 4. Group 组件修复

- 重写 `Group.vue` 子组件定位逻辑（相对父容器偏移 + 保留 rotation / zIndex）
- 确保组合拖动时子组件位置关系保持正确

## Bug 修复汇总

| 序号 | 问题                                | 根因                            | 修复要点                           | 文件                   |
| ---- | ----------------------------------- | ------------------------------- | ---------------------------------- | ---------------------- | ----------- | --------- |
| 1    | useComponentEvents 分散             | 事件逻辑分布多处                | 合并到 events.ts                   | events.ts / 删除旧文件 |
| 2    | 事件面板修改无效                    | 只读 computed 无 setter         | 改为带 getter/setter 的 computed   | events.vue             |
| 3    | 自定义事件重命名异常                | inline v-model 对象引用不稳定   | 使用 promptRenameEvent             | events.vue             |
| 4    | shape.ts TS 警告                    | targetContainer 可能 undefined  | 添加存在性检查 / 移除未用参数      | shape.ts               |
| 5    | KPI stat displayChange.toFixed 报错 | 非数字数据进入 toFixed          | typeof 判断 + try/catch 回退       | stat.vue               |
| 6    | 表格 fixed 属性类型警告             | 传入不符合 el-table-column 接口 | 规范 `:fixed="col.fixed            |                        | undefined"` | table.vue |
| 7    | 列表 scrollHeight 不兼容            | 高度字符串/数值不统一           | computed 归一化 px/%               | list.vue               |
| 8    | 模板 chart.bar 不存在               | 组件注册名错误 (应为 barChart)  | 全部替换为 barChart                | templates/index.ts     |
| 9    | 模板栏左右贴边                      | 缺少内边距                      | padding: 8px 12px / 12px 16px      | componentBar.vue       |
| 10   | 关系图收起不生效                    | 收起仅切换标记未改变高度        | 调整 graphHeight 300px / 60px 切换 | componentBar.vue       |
| 11   | emitsOptions null 报错              | 深层生命周期 / 初始化时机问题   | 标记为已知待深度排查               | （暂未改）             |

## 技术实现要点

- 模板加载 `loadTemplate()`：`reset()` 清空画布 → 深拷贝写入 → `commit()` 进历史栈，支持撤销
- 动画统一结构：`{ name,class,duration,delay,iterationCount,timingFunction,trigger }`
- 代码生成分层：`generateTemplate()` / `generateScript()` / `generateStyle()` / 事件函数拼装
- Group 子组件定位：父子绝对坐标差值计算 + 绝对定位渲染
- 事件数组可写 computed：通过 setter 修改 selectComponent 内部数组保持响应式
- 统一异常防护：数值运算前做类型检查 + try/catch 回退默认值

## 测试验证清单（执行 / 推荐）

### 模板加载

- 各模板一键加载后组件位置 / 尺寸 / 动画正确
- 撤销 (Ctrl+Z) 可回滚至空画布 / 之前状态

### 事件面板

- 新增 / 删除 / 修改 click / hover / dblclick 事件动作生效
- 自定义事件新增 → 重命名 → 添加动作 → 删除动作 → 删除事件 全流程 OK

### KPI / 图表组件

- stat 组件加载异常值（非数字）不崩溃
- barChart / lineChart / pieChart / radarChart 正常渲染

### 保存 / 加载 / 导出

- 保存后刷新浏览器 → 加载恢复一致
- 导出 JSON / Vue 文件内容结构完整
- 预览页面与编辑画布视觉一致，无编辑辅助元素

### Group 组件

- 组合多个子组件后拖动 / 旋转父级不破坏相对布局

## 已知限制 & 待深入问题

1. emitsOptions null：需要梳理组件创建顺序与事件注册时机，可能与批量初始化 + 异步挂载相关。
2. prompt 重命名使用原生 `prompt()`：后续可替换为 Element Plus 弹窗提升 UX。
3. 代码生成未包含数据源 / 异步加载逻辑：需后续增加钩子模板。
4. 地图占位为 Text：需接入真实地图组件（可能涉及第三方 SDK 初始化）。
5. 条件表达式未做语法校验：未来考虑添加安全解析或沙箱执行。

## 今日遗留 & 明日计划

- 深入排查 emitsOptions 初始化异常栈
- 增加地图真实组件并调整 GIS 模板
- 模板预览图设计与加载前缩略展示
- 模板自定义保存 / 用户分享机制雏形
- 事件执行日志 & 调试面板（便于排错）
- 条件脚本语法校验（AST 或 安全白名单）
- 代码生成：增加 TypeScript 类型导出与更优样式分组

## 关键文件变更列表（核心）

- `src/templates/index.ts` 新增模板定义 + 修正 barChart 类型
- `src/stores/component.ts` 新增 `loadTemplate()` 方法
- `src/components/componentBar.vue` 模板 Tab、布局与关系图折叠修复
- `src/utils/toCode.ts` 代码生成核心（371 行）
- `src/pages/runtimeView.vue` 预览 & 导出交互
- `src/components/header.vue` 保存 / 加载 / 导出入口
- `src/customComponents/kpi/stat/stat.vue` 安全类型处理
- `src/customComponents/data/table/table.vue` fixed 属性修复
- `src/customComponents/data/list/list.vue` scrollHeight 归一化
- `src/customComponents/group/Group.vue` 子组件定位实现
- `src/components/siderBar/events/events.ts / events.vue` 事件系统集中与可写 computed

## 回滚与安全

- 所有模板加载操作进入历史，可用撤销快捷键回滚
- 项目状态可通过导出的 JSON 手动恢复
- 关键重构（事件系统迁移 / Group 重写）保持原接口形态，减少外部依赖断裂风险

## 总结

模板系统与代码生成链路打通，支持“设计 → 预览 → 导出”全流程；主要组件在批量加载场景下稳定运行。剩余问题集中在生命周期顺序与高级编辑体验层面，后续将围绕可视化调试与真实业务组件（地图等）扩展深化。整体达到“初版可用 + 快速演示”标准。🎯
