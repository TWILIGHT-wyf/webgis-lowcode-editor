# 开发日志 - 2025年11月22日

## 本次更新内容 (相较于上次 commit: e4646bc)

### 🐛 问题修复

#### 1. 修复 Video 组件类型错误

- **问题**: `objectFit` 属性类型不兼容
- **解决**: 使用类型断言 `as 'fill' | 'contain' | 'cover' | 'none'`
- **文件**: `src/customComponents/media/video/video.vue`

#### 2. 修复 HTML 和 iframe 组件未渲染问题

- **问题**: 组件被存储到 componentStore 但画布中不显示
- **原因**:
  - HTML 组件默认内容不够明显
  - iframe 组件默认 URL 为空字符串
- **解决**:
  - HTML: 添加带渐变背景和样式的默认内容
  - iframe: 设置默认 URL 为 OpenStreetMap 地图
- **文件**: `src/stores/component.ts`

---

### ✨ 新增功能

#### 3. 创建 Scripting 组件 (脚本执行器)

- **功能**: JavaScript 代码沙箱执行环境
- **特性**:
  - 安全沙箱执行 (Function 构造函数)
  - 自定义 console 对象捕获日志
  - 支持手动触发/自动执行模式
  - 代码显示区 + 输出区
  - 错误捕获与提示
  - 暗色主题 UI (VS Code 风格)
- **配置项**:
  - script: JavaScript 代码
  - autoRun: 自动执行开关
  - showCode: 显示代码区
  - showControls: 显示执行按钮
  - showPlaceholder: 显示占位提示
- **数据源**: 支持从 API 获取脚本代码 (scriptField)
- **文件**: `src/customComponents/advanced/scripting/scripting.vue`

#### 4. 创建 State 组件 (状态管理器)

- **功能**: JSON 状态数据可视化展示
- **特性**:
  - 三种视图模式:
    - 列表视图: 分组展示键值对,带类型标签
    - JSON 视图: 格式化的 JSON 文本
    - 表格视图: Element Plus 表格展示
  - 自动解析 JSON 数据
  - 类型检测与着色 (string/number/boolean/object)
  - 实时数据同步
  - 暗色主题 UI
- **配置项**:
  - state: JSON 状态数据
  - viewMode: 视图模式 (list/json/table)
  - placeholder: 空数据提示
- **数据源**: 支持从 API 获取状态数据 (stateField)
- **文件**: `src/customComponents/advanced/state/state.vue`

#### 5. 创建 Trigger 组件 (触发器)

- **功能**: 定时/手动触发器,执行预设动作
- **特性**:
  - 两种触发方式:
    - 手动触发: 点击按钮执行
    - 定时触发: 按间隔自动执行
  - 四种动作类型:
    - log: 日志记录
    - alert: 弹窗提示
    - dispatch: 派发事件
    - api: 调用 API
  - 实时日志记录 (时间戳 + 消息 + 类型)
  - 日志类型着色 (info/success/warning/error)
  - 启用/禁用开关
  - 清除日志功能
  - 暗色主题 UI
- **配置项**:
  - enabled: 启用状态
  - triggerType: 触发类型 (manual/interval)
  - interval: 触发间隔 (毫秒)
  - action: 动作类型
  - actionData: 动作数据
  - condition: 触发条件 (预留)
  - showClearButton: 显示清除按钮
- **数据源**: 支持从 API 获取触发条件 (conditionField)
- **文件**: `src/customComponents/advanced/trigger/trigger.vue`

---

### 🔧 配置更新

#### 6. 组件注册

- 在 `registry.ts` 中注册三个新组件:
  - scripting (脚本执行器)
  - state (状态管理器)
  - trigger (触发器)
- **文件**: `src/customComponents/registry.ts`

#### 7. Component Store 配置

- **defaultStyleByType**: 为三个高级组件添加默认样式
  - 暗色主题背景色
  - 等宽字体 (Consolas, Monaco)
  - 统一的内边距、边框、圆角
- **defaultPropsByType**: 添加默认属性配置
  - scripting: 示例 JavaScript 代码
  - state: 示例状态 JSON
  - trigger: 默认触发器配置
- **defaultDataSourceByType**: 配置数据源字段映射
  - scriptField, stateField, conditionField
- **文件**: `src/stores/component.ts`

#### 8. Mock API 添加

- **API #37**: `/api/scripting` - 脚本代码数据
  - 随机返回三种示例脚本:
    - 斐波那契数列计算
    - 随机数据统计
    - 日期时间操作
- **API #38**: `/api/state` - 状态数据
  - 系统信息 (name, version, uptime, status)
  - 用户信息 (id, name, role, permissions)
  - 统计数据 (totalUsers, activeUsers, errorRate)
  - 配置信息 (theme, language, autoSave)
  - 实时数据 (timestamp, temperature, humidity, pressure)
- **API #39**: `/api/trigger` - 触发器配置
  - 随机返回动作类型和数据
  - 条件表达式
  - 启用状态
- **文件**: `test/mockServer.mjs`

#### 9. Properties 属性面板配置

##### styleSchema (样式配置)

为三个高级组件添加样式字段:

- padding (内边距)
- backgroundColor (背景颜色)
- textColor (文字颜色)
- fontSize (字体大小)
- lineHeight (行高)
- borderRadius (圆角)
- border (边框)
- fontFamily (字体)

##### dataSourceSchema (数据源配置)

为三个高级组件配置数据源:

- enabled (启用开关)
- url (API 地址)
- method (请求方法)
- interval (自动刷新)
- dataPath (数据路径)
- 字段映射 (scriptField/stateField/conditionField)
- headers (请求头)

##### componentSchema (组件属性配置)

- **scripting**:
  - script: JavaScript 代码
  - autoRun: 自动执行
  - showCode: 显示代码
  - showControls: 显示控制按钮
  - showPlaceholder: 显示占位提示
- **state**:
  - state: 状态数据 (JSON)
  - viewMode: 视图模式 (list/json/table)
  - placeholder: 占位提示
- **trigger**:
  - enabled: 启用触发器
  - triggerType: 触发类型 (manual/interval)
  - interval: 触发间隔
  - action: 动作类型 (log/alert/dispatch/api)
  - actionData: 动作数据
  - condition: 触发条件
  - showClearButton: 显示清除按钮

**文件**: `src/components/siderBar/properties/properties.ts`

---

### 📦 依赖更新

- 已安装依赖 (上次 commit):
  - marked (Markdown 渲染)
  - dompurify (XSS 防护)
  - @types/dompurify (类型定义)

---

### 📊 组件统计

#### 新增组件

- scripting (脚本执行器) - 高级功能
- state (状态管理器) - 高级功能
- trigger (触发器) - 高级功能

#### 总组件数量

- KPI 组件: 6 个
- 图表组件: 10 个
- 数据组件: 5 个
- 控件组件: 8 个
- 布局组件: 7 个
- 媒体组件: 2 个
- 内容组件: 3 个
- **高级功能: 3 个**
- **总计: 44 个组件**

---

### 🎯 技术亮点

1. **安全沙箱执行**: 使用 Function 构造函数创建隔离环境,防止恶意代码
2. **自定义 Console**: 捕获 console.log/error/warn 输出到组件内
3. **多视图模式**: State 组件支持 3 种视图切换,满足不同场景
4. **实时日志系统**: Trigger 组件带时间戳和类型着色的日志记录
5. **定时器管理**: Trigger 组件生命周期管理,自动清理定时器
6. **类型检测**: State 组件自动识别数据类型并着色显示
7. **暗色主题**: 三个高级组件统一使用 VS Code 风格暗色主题
8. **高度可配置**: 每个组件都支持样式、属性、数据源三层配置

---

### 🔄 工作流程

用户通过以下方式使用高级组件:

1. **从组件面板拖拽**: 在"高级功能"分类下选择组件
2. **放置到画布**: 组件自动应用默认配置
3. **属性面板配置**:
   - 样式: 调整颜色、字体、边距等
   - 数据源: 连接后端 API
   - 组件属性: 配置行为和显示选项
4. **实时预览**: 所有改动立即反映在画布中
5. **数据联动**: 可通过数据源与其他组件联动

---

### 📝 待优化项

1. Trigger 组件的条件判断功能 (已预留 condition 字段)
2. Scripting 组件的代码编辑器 (可集成 Monaco Editor)
3. State 组件的数据编辑功能
4. 高级组件之间的联动 (如 Trigger 触发 Scripting 执行)
5. 错误边界处理和日志记录系统

---

### ✅ 本次开发总结

本次更新主要完成了三个高级功能组件的开发,为平台增加了脚本执行、状态管理和触发器功能。这些组件:

- ✅ 支持完整的样式自定义
- ✅ 支持数据源集成
- ✅ 提供丰富的配置选项
- ✅ 使用暗色主题统一视觉风格
- ✅ 完整的 Mock API 测试支持
- ✅ 详细的属性面板配置

同时修复了 video、html、iframe 组件的已知问题,提升了组件库的整体质量和可用性。
