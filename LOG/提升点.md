# 提升与扩展清单（持续更新）

## 已发现并已处理的问题

- barChart 属性面板无配置：原因是类型不匹配（schema 使用 `chart.bar`，组件注册为 `barChart`）。已在 `properties.ts` 兼容 `barChart | chart.bar`，并在 `component.ts` 的默认属性中改用 `barChart`，同时为 `stackedBarChart` 对齐默认属性与 schema。
- 模板配色对比度不足：为深色卡片上的 KPI 文本增加高对比色（titleColor/valueColor/changeColor），并为 Dashboard 内的三张图表注入 ECharts `option`（title/legend/axisLabel 文字颜色与网格线色），提升可读性。
- 主题切换无效果：引入全局 `theme.css`（CSS 变量），`header.vue` 改为使用变量；`body` 加 `theme-dark` 类后生效。

## 仍可改进项（短期）

- 主题系统
  - 用 CSS 变量统一替换编辑器内的静态颜色（组件栏、属性面板、画布、卡片等）。
  - 支持跟随系统主题（prefers-color-scheme），并持久化用户选择。
  - 为 ECharts 统一提供主题适配：在各图表组件中读取 CSS 变量，自动设置标题、轴标签、图例颜色与分隔线颜色。

- 模板可读性与一致性
  - 对所有模板中的文本与图表，提供一套暗色/亮色的默认 `option` 片段，保证对比度达标（WCAG AA）。
  - 替换临时占位 Text 为真实容器（panel/row/col）或实际地图组件，完善 GIS 模板。
  - 模板预览图与一键预览对比（预估渲染效果一致性）。

- 组件属性与默认值
  - 为 `barChart/stackedBarChart/lineChart/pieChart` 增加文字与轴线颜色配置项（如 `axisLabelColor`、`legendTextColor`、`splitLineColor`）。
  - 清理遗留的 `chart.*` 命名前缀，统一与注册表一致的 `*Chart` 命名，避免属性/默认值缺失。

- 稳定性与可观察性
  - emitsOptions 相关报错：梳理组件创建顺序与事件注册时机，必要时在创建阶段做 `emits` 安全判空与延迟绑定。
  - 增加错误边界与全局日志（组件加载失败、数据源异常、脚本执行异常）。

## 中期优化方向

- 数据源与安全
  - 引入 JSON Schema 校验组件配置与模板数据（编译期与运行期双校验）。
  - 数据源请求白名单与 CORS/鉴权适配，提供统一的 headers/payload 管理。
  - 自定义脚本沙箱（限制可用 API，提供安全白名单），并在预览/运行时隔离。

- 交互与编辑体验
  - 组件对齐辅助线、间距与分布工具、智能吸附（更强的 snap）。
  - 拖拽性能优化（虚拟化渲染/批量 DOM 更新/节流）。
  - 画布缩放的锚点优化与平滑滚动。

- 模板与资产
  - 模板市场与分享：导入/导出模板包（含预览、标签、版本）。
  - 自定义模板保存（从当前画布一键生成模板并供复用）。
  - 资产管理（图片/视频/GeoJSON 等），支持引用/替换与离线缓存。

- 工程与质量
  - 单元测试（属性面板 schema 映射、代码生成、数据源解析）。
  - E2E（模板加载 → 预览 → 导出）、可用性对比快照。
  - 性能指标与埋点（加载耗时、交互延迟、渲染帧率）。

## “建议面板”方案（AI Assist）

目标：在编辑器内集成一个建议面板，用户输入自然语言，Agent 返回候选组件树或配置片段；编辑器先展示 diff，高亮自动生成部分，用户可一键接受/编辑；对产出做 schema 校验与安全审查（白名单函数/组件），记录生成来源（audit trail），并允许回退。

### 流程设计

1. 输入：用户在建议面板输入自然语言意图（如“来个双列 KPI + 折线/柱状图 + 右侧饼图”）。
2. 调用：将当前画布上下文（组件树/画布尺寸/主题等）+ 用户意图传给 Agent。
3. 返回：标准化的建议结果（JSON）——组件树、属性片段或数据源片段。
4. 校验：用 JSON Schema 校验；基于白名单的组件与函数过滤；危险字段（如 `script`）沙箱隔离。
5. 预览：在 UI 展示 diff 视图（新增/修改高亮），用户可逐项接受或整体应用。
6. 执行：应用变更，写入历史栈，支持一键回退。
7. 审计：记录生成来源（prompt、时间、Agent 版本、变更摘要），可导出/回放。

### 数据约束（草案）

```ts
type SuggestionKind = 'component-tree' | 'props-patch' | 'data-source' | 'event-actions'

interface SuggestionResult {
  kind: SuggestionKind
  description?: string
  changes: Array<
    | { type: 'add'; component: component }
    | { type: 'update'; id: string; patch: Partial<component> }
    | { type: 'remove'; id: string }
  >
  audit: {
    model: string // Agent 标识
    promptHash: string
    createdAt: string
  }
}
```

### 安全与合规

- 白名单：仅允许注册表中存在的组件与已声明的 props 字段。
- 脚本：所有 `script/scripting` 类组件的代码注入走沙箱，禁用危险 API；仅允许调用白名单工具函数。
- 校验：变更前后做 JSON Schema 校验，失败直接拒绝应用；在 UI 中展示错误原因与定位。

### UI 交互

- 面板分区：输入区 / 候选列表 / 预览区 / diff 区 / 审计信息。
- 高亮：新增（绿）、修改（蓝）、删除（红）；支持按组件类型过滤。
- 操作：单项接受、全部接受、撤销与重做。

### 实现建议

- 使用统一的 `applySuggestion(result: SuggestionResult)` 入口，内部转换为对 componentStore 的原子操作（可撤销）。
- 封装 `validateSuggestion(result)`，串行执行 schema 校验、白名单校验、安全审查。
- 提供 `toSuggestionJSON()` 与 `fromSuggestionJSON()`，便于导出/回放与调试。

## 后续 Roadmap（建议）

- 主题：完成全局 CSS 变量替换与 ECharts 主题适配；提供主题包（海蓝/深空/清雅等）。
- 模板：补足 GIS 真实组件与数据，增加行业模板；模板预览 + 新手引导。
- AI：建议面板 MVP（仅 props-patch 与简单布局），逐步扩展到全量组件树与事件链路。
- 工程：lint 规则与 commit 规范落地，关键模块单测覆盖 60%+；e2e 验证关键流程。

---

如需我把建议面板的 MVP 数据结构和 API 草案同步落库（含类型与空实现），告诉我是放在 `src/ai/` 还是 `src/services/`。
